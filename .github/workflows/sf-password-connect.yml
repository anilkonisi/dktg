name: Snowflake Password Auth Test
on:
  workflow_dispatch: {}

jobs:
  connect:
    runs-on: ubuntu-latest
    env:
      ACCOUNT_LOCATOR:   ${{ secrets.ACCOUNT_LOCATOR }}
      LOGIN_NAME:      ${{ secrets.LOGIN_NAME }}
      SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE:      ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DB:        ${{ secrets.SNOWFLAKE_DB }}
      SNOWFLAKE_SCHEMA:    ${{ secrets.SNOWFLAKE_SCHEMA }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake connector
        run: pip install snowflake-connector-python

      - name: Test Snowflake connection with password
        shell: python
        run: |
          import os, sys
          import snowflake.connector as sf

          try:
              ctx = sf.connect(
                  account=os.environ["ACCOUNT_LOCATOR"],
                  user=os.environ["LOGIN_NAME"],
                  password=os.environ["SNOWFLAKE_PASSWORD"],
                  role=os.environ["SNOWFLAKE_ROLE"],
                  warehouse=os.environ["SNOWFLAKE_WAREHOUSE"],
                  database=os.environ["SNOWFLAKE_DB"],
                  schema=os.environ["SNOWFLAKE_SCHEMA"],
                  # authenticator='snowflake' is the default, so can be omitted
              )
              cur = ctx.cursor()
              cur.execute("SELECT CURRENT_USER(),CURRENT_USER(), CURRENT_ROLE(), CURRENT_WAREHOUSE(), CURRENT_DATABASE(), CURRENT_SCHEMA()")
              print("Connected. Context:", " | ".join(str(x) for x in cur.fetchone()))
          except Exception as e:
              print("Connection failed:", e)
              sys.exit(1)
          finally:
              try:
                  cur.close(); ctx.close()
              except:
                  pass
